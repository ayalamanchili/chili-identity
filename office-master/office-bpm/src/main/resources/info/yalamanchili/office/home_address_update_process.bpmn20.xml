<?xml version="1.0" encoding="UTF-8"?>
<!--

    System Soft Technologies Copyright (C) 2013 ayalamanchili@sstech.mobi

-->
<definitions
    xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    targetNamespace="http://www.bpmnwithactiviti.org"
    xmlns:activiti="http://activiti.org/bpmn">
 
    <process id="home_address_update_process">
 
        <startEvent id="updateAddressStart" />
        <sequenceFlow sourceRef="updateAddressStart" targetRef="sendAddressChangeRequestReceivedEmail" />
        <!-- Address Change Request Received Email Task-->
        <serviceTask id="sendAddressChangeRequestReceivedEmail" 
                     name="Address Change Request Received Email" 
                     activiti:expression="#{homeAddressChangeProcessBean.sendAddressChangeRequestSubmittedEmail(entity)}" />
        <sequenceFlow sourceRef="sendAddressChangeRequestReceivedEmail" targetRef="sendAddressChangeRequestEEMNotifyEmail" />
        <serviceTask id="sendAddressChangeRequestEEMNotifyEmail" 
                     name="Address Change Request EEM Team Notification Email" 
                     activiti:expression="#{homeAddressChangeProcessBean.sendAddressChangeRequestEEMNotificationEmail(entity)}" />        
        <sequenceFlow sourceRef="sendAddressChangeRequestEEMNotifyEmail" targetRef="publishToExternalSystems" />
        <serviceTask id="publishToExternalSystems" 
                     name="Publish update to external systems" 
                     activiti:expression="#{homeAddressChangeProcessBean.publishToExternalSystems(entity)}" />  
        <sequenceFlow sourceRef="publishToExternalSystems" targetRef="createTasks" />      
        <inclusiveGateway id="createTasks" />
        <!-- Parallel Payroll Dept Task-->
        <sequenceFlow sourceRef="createTasks"
                      targetRef="updateAddressPayrollTask">
        </sequenceFlow> 
        <userTask id="updateAddressPayrollTask" 
                  name="Address Updated Payroll Dept Task for ${employeeName}" 
                  activiti:candidateGroups="ROLE_PAYROLL_AND_BENIFITS">
            <documentation>
                Employee Primary Residential Address is updated in portal.
                1) Please update in other systems as applicable. Eg: ADP, BIS, SMS, CITS etc...
                2) Please click complete on this task when other systems are updated.
                
                Company                             : ${company}
                Address Change Notes From Employee  : ${entity.changeNotes} 
                Street1                             : ${entity.street1}
                Street2                             : ${entity.street2}
                City, State, Zip                    : ${entity.city}, ${entity.state}, ${entity.zip} 
                More Information : https://apps.sstech.us/site/office/bpm/address-updated-process.html
            </documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="info.yalamanchili.office.bpm.address.HomeAddressChangeProcess" />
                <activiti:taskListener event="complete" class="info.yalamanchili.office.bpm.address.HomeAddressChangeProcess" />
                <activiti:formProperty id="payrollDeptNotes" type="string" required="true" name="Notes"/>
            </extensionElements>             
        </userTask>
        <exclusiveGateway id="payrollTaskGateway" />
        <sequenceFlow sourceRef="updateAddressPayrollTask" 
                      targetRef="waitForTasks">
            <conditionExpression>
                ${allTasksCompleted == true}
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="updateAddressPayrollTask" 
                      targetRef="updateAddressEnd">
            <conditionExpression>
                ${allTasksCompleted == false}
            </conditionExpression>
        </sequenceFlow>
        <!--Payroll Task escalation email after 2 days-->
        <boundaryEvent id="payrollTaskEmailEscalationTimer"
                       cancelActivity="false" 
                       attachedToRef="updateAddressPayrollTask">
            <timerEventDefinition> 
                <timeDuration>PT48H</timeDuration> 
            </timerEventDefinition>
        </boundaryEvent>
        <sequenceFlow sourceRef="payrollTaskEmailEscalationTimer" 
                      targetRef="payrollTaskEmailEscalation" />
        <serviceTask
            id="payrollTaskEmailEscalation"
            name="Task Email Escalation"
            activiti:class="info.yalamanchili.office.bpm.EmailEscalation">
        </serviceTask>        

        <sequenceFlow sourceRef="createTasks"
                      targetRef="updateHealthInsuranceTask">
            <conditionExpression>
                ${notifyHealthInsurance == true}
            </conditionExpression>
        </sequenceFlow> 
        <userTask id="updateHealthInsuranceTask" 
                  name="Address Updated Health Insurance Dept Task for ${employeeName}" 
                  activiti:candidateGroups="ROLE_HEALTH_INSURANCE_MANAGER">
            <documentation>
                Employee Primary Residential Address is updated in portal.
                1) Please update Health Insurance systems as applicable. 
                
                Company                             : ${company}
                Address Change Notes From Employee  : ${entity.changeNotes} 
                Street1                             : ${entity.street1}
                Street2                             : ${entity.street2}
                City, State, Zip                    : ${entity.city}, ${entity.state}, ${entity.zip} 
                More Information : https://apps.sstech.us/site/office/bpm/address-updated-process.html
            </documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="info.yalamanchili.office.bpm.address.HomeAddressChangeProcess" />
                <activiti:taskListener event="complete" class="info.yalamanchili.office.bpm.address.HomeAddressChangeProcess" />
                <activiti:formProperty id="healthInsuranceDeptNotes" type="string" required="true" name="Notes"/>
            </extensionElements>             
        </userTask>
        <exclusiveGateway id="healthInsuranceTaskGateway" />
        <sequenceFlow sourceRef="updateHealthInsuranceTask" 
                      targetRef="waitForTasks">
            <conditionExpression>
                ${allTasksCompleted == true}
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow sourceRef="updateHealthInsuranceTask" 
                      targetRef="updateAddressEnd">
            <conditionExpression>
                ${allTasksCompleted == false}
            </conditionExpression>
        </sequenceFlow>         
        <!--Payroll Task escalation email after 2 days-->
        <boundaryEvent id="healthInsuranceTaskEmailEscalationTimer"
                       cancelActivity="false" 
                       attachedToRef="updateHealthInsuranceTask">
            <timerEventDefinition> 
                <timeDuration>PT24H</timeDuration> 
            </timerEventDefinition>
        </boundaryEvent>
        <sequenceFlow sourceRef="healthInsuranceTaskEmailEscalationTimer" 
                      targetRef="healthInsuranceTaskEmailEscalation" />
        <serviceTask
            id="healthInsuranceTaskEmailEscalation"
            name="Task Email Escalation"
            activiti:class="info.yalamanchili.office.bpm.EmailEscalation">
        </serviceTask>     
            
        <inclusiveGateway id="waitForTasks" />
        
        <sequenceFlow sourceRef="waitForTasks" targetRef="updateAddressHRAdminTask" />
        <!--  Final HR Aadmin task-->
        <userTask id="updateAddressHRAdminTask" 
                  name="Address Updated HR Admin Task for ${employeeName}" 
                  activiti:candidateGroups="ROLE_HR_ADMINSTRATION">
            <documentation>
                Employee Primary Residence Address is updated in portal.
                All departments have update the necessary information.
                Please review and complete.
                
                Company                             : ${company}
                Address Change Notes From Employee  : ${entity.changeNotes} 
                Street1                             : ${entity.street1}
                Street2                             : ${entity.street2}
                City, State, Zip                    : ${entity.city}, ${entity.state}, ${entity.zip} 
                --------------------------------------#Notes#----------------------------------------------------------------
                Payroll Dept Notes                  : ${payrollDeptNotes} 

                -------------------------------------------------------------------------------------------------------------                
                More Information : https://apps.sstech.us/site/office/bpm/address-updated-process.html
            </documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="info.yalamanchili.office.bpm.address.HomeAddressChangeProcess" />
                <activiti:taskListener event="complete" class="info.yalamanchili.office.bpm.address.HomeAddressChangeProcess" />
                <activiti:formProperty id="hrAdminDeptNotes" type="string" required="false" name="Notes"/>
            </extensionElements>             
        </userTask>
        <sequenceFlow sourceRef="updateAddressHRAdminTask" targetRef="sendAddressChangeRequestCompletedEmail" />
        <!--Immigration Task escalation email after 2 days-->
        <boundaryEvent id="hrAdminTaskEmailEscalationTimer"
                       cancelActivity="false" 
                       attachedToRef="updateAddressHRAdminTask">
            <timerEventDefinition> 
                <timeDuration>PT24H</timeDuration> 
            </timerEventDefinition>
        </boundaryEvent>
        <sequenceFlow sourceRef="hrAdminTaskEmailEscalationTimer" 
                      targetRef="hrAdminTaskEmailEscalation" />
        <serviceTask
            id="hrAdminTaskEmailEscalation"
            name="Task Email Escalation"
            activiti:class="info.yalamanchili.office.bpm.EmailEscalation">
        </serviceTask> 
        
        <!-- Address Change Request Completed Email Task-->
        <serviceTask id="sendAddressChangeRequestCompletedEmail" 
                     name="Address Change Request Completed Email" 
                     activiti:expression="#{homeAddressChangeProcessBean.sendAddressChangeRequestCompletedEmail(entity)}" />
        <sequenceFlow sourceRef="sendAddressChangeRequestCompletedEmail" targetRef="updateAddressEnd" />
        
        <endEvent id="updateAddressEnd" />
    </process>
 
</definitions>