<?xml version="1.0" encoding="UTF-8"?>
<!--

    System Soft Technologies Copyright (C) 2013 ayalamanchili@sstech.mobi

-->
<definitions
    xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
    targetNamespace="http://www.bpmnwithactiviti.org"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:activiti="http://activiti.org/bpmn">
 
    <process id="account_reset_process">
        <startEvent id="accountResetStart">
        </startEvent>
        <sequenceFlow id="flow1" sourceRef="accountResetStart" targetRef="accountResetApprovalTask" />
        <userTask id="accountResetApprovalTask" 
                  name="Account Reset Task" 
                  activiti:candidateGroups="ROLE_RELATIONSHIP,ROLE_ADMIN,ROLE_HR">
            <documentation>
                Account Reset Task for
                FirstName= ${account.firstName} 
                LastName= ${account.lastName} 
                Email= ${account.email} 
                Phone= ${account.phoneNumber} 
                Date of Birth= ${account.dateOfBirth} 
                Start Date=${account.startDate}
                Please verify if the account exists for this user
                if exists reset the password and reject task with login details 
                else if create the account and approve the task with login details.
            </documentation>
            <extensionElements>
                <activiti:taskListener event="create" class="info.yalamanchili.office.bpm.email.GenericTaskCreateNotification" />
                <activiti:taskListener event="complete" class="info.yalamanchili.office.bpm.email.AccountResetCompleteNotification" />
                <activiti:formProperty id="status" 
                                       name="Approved?"
                                       required="true"
                                       type="enum">
                    <activiti:value id="approved" name="approved"/>
                    <activiti:value id="rejected" name="rejected"/>
                </activiti:formProperty>
                <activiti:formProperty id="username" 
                                       name="Username"
                                       required="true" 
                                       variable="username"
                                       type="string" />
                <activiti:formProperty id="password" 
                                       name="Password"
                                       variable="password"
                                       required="true" 
                                       type="string" />
                <activiti:formProperty id="notes" 
                                       name="Notes"
                                       required="false" 
                                       type="string" />
            </extensionElements> 
        </userTask>
        <!-- Task escalation email after 7 days-->
        <boundaryEvent id="emailEscalationTimer"
                       cancelActivity="false" 
                       attachedToRef="accountResetApprovalTask">
            <timerEventDefinition> 
                <timeDuration>PT168H</timeDuration> 
            </timerEventDefinition>
        </boundaryEvent>
        <sequenceFlow sourceRef="emailEscalationTimer" 
                      targetRef="taskEmailEscalation" />
        <serviceTask
            id="taskEmailEscalation"
            name="Task Email Escalation"
            activiti:class="info.yalamanchili.office.bpm.EmailEscalation">
        </serviceTask>
        <sequenceFlow id="flow4" sourceRef="accountResetApprovalTask" targetRef="accountResetEnd" />
        <!-- end-->
        <endEvent id="accountResetEnd" />
    </process>
</definitions>